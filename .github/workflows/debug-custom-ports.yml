name: Debug Custom Ports

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/debug-custom-ports.yml'
      - 'tests/sta2ble-custom-ports/**'

jobs:
  test-custom-ports:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Python dependencies
        run: python -m pip install firebase-admin requests
      
      - name: Setup Firebase Emulators
        uses: ./
        with:
          working-directory: tests/sta2ble-custom-ports
          project-id: demo-sta2ble-ports
          wait-time: 120
      
      - name: Check which ports are actually listening
        run: |
          Write-Host "`n=== Port Connectivity Check ===" -ForegroundColor Cyan
          
          Write-Host "`nCustom ports (from firebase.json):"
          $customAuth = Test-NetConnection -ComputerName 127.0.0.1 -Port 17641 -InformationLevel Quiet -WarningAction SilentlyContinue
          Write-Host "  17641 (Auth): $customAuth" -ForegroundColor $(if ($customAuth) { 'Green' } else { 'Red' })
          
          $customFirestore = Test-NetConnection -ComputerName 127.0.0.1 -Port 17644 -InformationLevel Quiet -WarningAction SilentlyContinue
          Write-Host "  17644 (Firestore): $customFirestore" -ForegroundColor $(if ($customFirestore) { 'Green' } else { 'Red' })
          
          Write-Host "`nDefault ports:"
          $defaultAuth = Test-NetConnection -ComputerName 127.0.0.1 -Port 9099 -InformationLevel Quiet -WarningAction SilentlyContinue
          Write-Host "  9099 (Auth): $defaultAuth" -ForegroundColor $(if ($defaultAuth) { 'Green' } else { 'Red' })
          
          $defaultFirestore = Test-NetConnection -ComputerName 127.0.0.1 -Port 8080 -InformationLevel Quiet -WarningAction SilentlyContinue
          Write-Host "  8080 (Firestore): $defaultFirestore" -ForegroundColor $(if ($defaultFirestore) { 'Green' } else { 'Red' })
          
          Write-Host "`nHub port:"
          $hub = Test-NetConnection -ComputerName 127.0.0.1 -Port 4400 -InformationLevel Quiet -WarningAction SilentlyContinue
          Write-Host "  4400 (Hub): $hub" -ForegroundColor $(if ($hub) { 'Green' } else { 'Red' })
      
      - name: Test Python connection to custom ports
        working-directory: tests/sta2ble-custom-ports
        env:
          FIREBASE_AUTH_EMULATOR_HOST: "127.0.0.1:17641"
          FIRESTORE_EMULATOR_HOST: "127.0.0.1:17644"
        run: |
          Write-Host "`n=== Python Connection Test (Custom Ports) ===" -ForegroundColor Cyan
          python quick_test.py
        continue-on-error: true
      
      - name: Test Python connection to default ports
        working-directory: tests/sta2ble-custom-ports
        env:
          FIREBASE_AUTH_EMULATOR_HOST: "127.0.0.1:9099"
          FIRESTORE_EMULATOR_HOST: "127.0.0.1:8080"
        run: |
          Write-Host "`n=== Python Connection Test (Default Ports) ===" -ForegroundColor Cyan
          python quick_test.py
        continue-on-error: true
      
      - name: Cleanup
        if: always()
        run: |
          nssm stop FirebaseEmulator
          nssm remove FirebaseEmulator confirm
          Stop-Process -Name "node","java" -Force -ErrorAction SilentlyContinue